<!DOCTYPE html>
<html>
<head>
    <title>BloodStrike Squad Planner</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Centered Viewport */
        #viewport { 
            flex-grow: 1; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            background: #000;
        }

        #map-wrapper { 
            position: relative; 
            transform-origin: center;
            transition: transform 0.1s ease-out;
        }

        #mapSource { display: block; max-height: 85vh; width: auto; pointer-events: none; user-select: none; }
        canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }

        /* UI Styling */
        .ui-top { padding: 15px; background: #1a1a1a; text-align: center; z-index: 20; border-bottom: 2px solid #333; }
        .ui-bottom { padding: 20px; background: #1a1a1a; display: flex; justify-content: center; gap: 10px; align-items: center; z-index: 20; border-top: 2px solid #333; }
        
        select, button { padding: 10px 18px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        
        /* Squad Color Buttons */
        .color-btn { width: 40px; height: 40px; border: 3px solid transparent; border-radius: 50%; }
        .color-btn.active { border-color: white; transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        .red { background: #ff4d4d; }
        .blue { background: #4d94ff; }
        .yellow { background: #ffdb4d; }
        .green { background: #4dff88; }

        .btn-undo { background: #444; color: white; margin-left: 20px; }
        .btn-clear { background: #b33939; color: white; }
        .btn-save { background: #218c74; color: white; }
        
        .zoom-info { position: absolute; bottom: 110px; right: 20px; font-size: 12px; color: #666; pointer-events: none; }
    </style>
</head>
<body>

    <div class="ui-top">
        <span style="font-weight: bold; margin-right: 15px; color: #aaa;">MAP:</span>
        <select id="mapSelector" onchange="changeMap()">
            <option value="shutter.jpg">Shutter Island</option>
            <option value="valley.jpg">Valley</option>
            <option value="sky.jpg">sky</option>
        </select>
    </div>

    <div id="viewport">
        <div id="map-wrapper">
            <img id="mapSource" src="shutter.jpg">
            <canvas id="drawingCanvas"></canvas>
        </div>
        <div class="zoom-info">Use Mouse Wheel to Zoom</div>
    </div>

    <div class="ui-bottom">
        <button class="color-btn red active" onclick="setColor('#ff4d4d', this)"></button>
        <button class="color-btn blue" onclick="setColor('#4d94ff', this)"></button>
        <button class="color-btn yellow" onclick="setColor('#ffdb4d', this)"></button>
        <button class="color-btn green" onclick="setColor('#4dff88', this)"></button>

        <button class="btn-undo" onclick="undo()">Undo</button>
        <button class="btn-clear" onclick="clearCanvas()">Clear All</button>
        <button class="btn-save" onclick="downloadMap()">Save Image</button>
    </div>

    <script>
        const wrapper = document.getElementById('map-wrapper');
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const img = document.getElementById('mapSource');
        
        let scale = 1;
        let drawing = false;
        let history = [];
        let currentColor = '#ff4d4d';

        // Set Squad Color
        function setColor(color, btn) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // Zoom Logic
        window.addEventListener('wheel', (e) => {
            e.preventDefault();
            scale += e.deltaY * -0.001;
            scale = Math.min(Math.max(.5, scale), 3);
            wrapper.style.transform = `scale(${scale})`;
        }, { passive: false });

        function syncSize() {
            canvas.width = img.width || img.clientWidth;
            canvas.height = img.height || img.clientHeight;
        }

        img.onload = syncSize;
        window.onresize = syncSize;

        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
            history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!drawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 4 / scale; // Line stays clean regardless of zoom
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
        });

        window.addEventListener('mouseup', () => drawing = false);

        function changeMap() {
            img.src = document.getElementById('mapSelector').value;
            clearCanvas();
            scale = 1;
            wrapper.style.transform = `scale(1)`;
        }

        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); history = []; }
        function undo() { if (history.length > 0) ctx.putImageData(history.pop(), 0, 0); }

        function downloadMap() {
            const tempCanvas = document.createElement('canvas');
            const tCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
            tCtx.drawImage(canvas, 0, 0);
            const link = document.createElement('a');
            link.download = 'squad_rotation.png';
            link.href = tempCanvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
